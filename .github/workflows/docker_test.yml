name: docker
on:
  push:
      paths:
        - 'backend/**'
        - 'frontend/**'
        - '.github/workflows/**'
        - 'docker/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tdo
      POSTGRES_PORT: "5432"
      BACKEND_PORT: "8000"
      FRONTEND_PORT: "3000"
      DATABASE_URL: postgresql+psycopg://postgres:postgres@db:5432/tdo

    steps:
      - uses: actions/checkout@v4
      - name: Start stack and run tests
        run: docker compose -f ./docker-compose.yml up -d --build

      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            if docker compose -f ./docker-compose.yml exec -T db \
              pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"; then
              echo "Postgres is ready"
              exit 0
            fi
            echo "Waiting for Postgres..."
            sleep 2
          done
          docker compose -f ./docker-compose.yml logs db
          exit 1

      # Connectivity checks 
      - name: Check backend -> db connection
        run: |
          docker compose -f ./docker-compose.yml exec -T backend \
            sh -c "nc -z db 5432"
